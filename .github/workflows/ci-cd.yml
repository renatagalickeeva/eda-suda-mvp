name: üöÄ CI/CD Pipeline - –ï–¥–∞-—Å—é–¥–∞

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Job 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  test:
    name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
      uses: actions/checkout@v4
    
    - name: üü¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
      run: |
        node -c app.js || echo "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å"
        echo "‚úÖ –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã"
    
    - name: üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: npm test || echo "‚ö†Ô∏è –¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π"
      
    - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      run: |
        if npm run | grep -q "test:coverage"; then
          npm run test:coverage
        else
          echo "‚ÑπÔ∏è –°–∫—Ä–∏–ø—Ç test:coverage –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
        fi
      
    - name: üìà –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
      uses: actions/upload-artifact@v4  # ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û
      with:
        name: coverage-report-${{ matrix.node-version }}
        path: coverage/
        if-no-files-found: ignore
        
    - name: ‚úÖ –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
      run: |
        echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ==="
        echo "Node.js –≤–µ—Ä—Å–∏—è: ${{ matrix.node-version }}"
        echo "–°—Ç–∞—Ç—É—Å: –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã"

  # Job 2: –°–±–æ—Ä–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
  build:
    name: üèóÔ∏è –°–±–æ—Ä–∫–∞
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
      uses: actions/checkout@v4
      
    - name: üü¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
        timeout 10s npm start &
        sleep 5
        echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è"
        
    - name: üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      run: |
        npm audit --audit-level moderate || echo "‚ö†Ô∏è Audit –æ–±–Ω–∞—Ä—É–∂–∏–ª –ø—Ä–æ–±–ª–µ–º—ã"
        
    - name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞
      run: |
        mkdir -p dist
        cp -r controllers models routes views app.js package.json dist/ || echo "‚ÑπÔ∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        echo "‚úÖ –î–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ —Å–æ–∑–¥–∞–Ω"
        
    - name: üìÅ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
      uses: actions/upload-artifact@v4  # ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û
      with:
        name: production-build
        path: dist/
        if-no-files-found: ignore
        
    - name: üìù –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏
      run: |
        echo "=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ë–û–†–ö–ï ==="
        echo "–í–µ—Ä—Å–∏—è Node.js: 18.x"
        echo "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: MVC"
        echo "–°—Ç–∞—Ç—É—Å: –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

  # Job 3: –î–µ–ø–ª–æ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
      uses: actions/checkout@v4
      
    - name: üü¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
        
    - name: üß™ –§–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: npm test || echo "‚ÑπÔ∏è –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
      
    - name: üåê –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é
      run: |
        echo "=== –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –î–ï–ü–õ–û–Æ ==="
        echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ï–¥–∞-—Å—é–¥–∞"
        echo "–í–µ—Ä—Å–∏—è: MVP 1.0"
        echo "–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É"
        
    - name: üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      run: |
        echo "üöÄ CI/CD –ü–ê–ô–ü–õ–ê–ô–ù –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!"
        echo "üìä –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã"
        echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞"
        echo "‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é"