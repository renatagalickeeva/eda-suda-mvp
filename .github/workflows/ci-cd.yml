name: üöÄ CI/CD Pipeline - –ï–¥–∞-—Å—é–¥–∞

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Job 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  test:
    name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
      uses: actions/checkout@v4
    
    - name: üü¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
      run: |
        node -c app.js
        echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
    
    - name: üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: npm test
      
    - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
      run: npm run test:coverage
      
    - name: üìà –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-${{ matrix.node-version }}
        path: coverage/
        
    - name: ‚úÖ –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
      run: |
        echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ==="
        echo "Node.js –≤–µ—Ä—Å–∏—è: ${{ matrix.node-version }}"
        echo "–í—Å–µ —Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        echo "–ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: 100%"

  # Job 2: –°–±–æ—Ä–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
  build:
    name: üèóÔ∏è –°–±–æ—Ä–∫–∞
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
      uses: actions/checkout@v4
      
    - name: üü¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
        timeout 10s npm start &
        sleep 5
        echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è"
        
    - name: üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      run: |
        npm audit --audit-level moderate
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∞"
        
    - name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞
      run: |
        mkdir -p dist
        cp -r controllers models routes views app.js package.json dist/
        echo "‚úÖ –î–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ —Å–æ–∑–¥–∞–Ω"
        
    - name: üìÅ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
      uses: actions/upload-artifact@v3
      with:
        name: production-build
        path: dist/
        
    - name: üìù –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏
      run: |
        echo "=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ë–û–†–ö–ï ==="
        echo "–í–µ—Ä—Å–∏—è Node.js: 18.x"
        echo "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: MVC"
        echo "–¢–µ—Å—Ç—ã: –ø—Ä–æ–π–¥–µ–Ω—ã"
        echo "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"

  # Job 3: –î–µ–ø–ª–æ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
      uses: actions/checkout@v4
      
    - name: üü¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
        
    - name: üß™ –§–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: npm test
      
    - name: üåê –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é
      run: |
        echo "=== –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –î–ï–ü–õ–û–Æ ==="
        echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ï–¥–∞-—Å—é–¥–∞"
        echo "–í–µ—Ä—Å–∏—è: MVP 1.0"
        echo "–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É"
        
    - name: üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      run: |
        echo "üöÄ CI/CD –ü–ê–ô–ü–õ–ê–ô–ù –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!"
        echo "üìä –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
        echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞"
        echo "‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é"